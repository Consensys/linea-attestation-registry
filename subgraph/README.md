# Verax - Subgraph

This subgraph aims to index the data generated by the smart contracts of Verax.

## How to use it?

Our subgraph is deployable on all the networks where Verax is deployed.  
You can replace `XXX` by the name of the networks you want to work on in the commands below:

- `linea-sepolia`
- `linea`
- `arbitrum-sepolia`
- `arbitrum-one`
- `base-sepolia`
- `base`
- `bsc-testnet`
- `bsc`

### 1. Generate code

```bash
pnpm run codegen:vY
```

### 2. Build the subgraph

```bash
pnpm run build:XXX:vY
```

### 3. Deploy the subgraph

```bash
pnpm run deploy:XXX:vY
```

## Deployment of a new Verax instance

When the contracts of a new Verax instance are deployed, we need to start indexing the data generated by these
contracts.

1. Add the new network config in the [networks.json](networks.json) file:
   ```json
   "XXX": {
       "AttestationRegistry": {
           "address": "0x...",
           "startBlock": 123
       },
       "ModuleRegistry": {
           "address": "0x...",
           "startBlock": 123
       },
       "PortalRegistry": {
           "address": "0x...",
           "startBlock": 123
       },
       "SchemaRegistry": {
           "address": "0x...",
           "startBlock": 123
       }
   },
   ```
2. Create a subgraph config file for the new network, based on the
   [subgraph.linea-mainnet.yaml](subgraph.linea-mainnet.yaml) file, name `subgraph.XXX.yaml`.
3. Add a "build" script in the [package.json](networks.json) file to easily build it:
   ```json
   "build:XXX:v2": "pnpm run codegen:v2 && graph build subgraph.XXX.yaml",
   ```
4. Add a "deploy" script in the [package.json](networks.json) file to easily deploy it
   ```json
   "deploy:XXX:v2": "graph deploy --version-label v0.0.1 --studio XXX subgraph.XXX.yaml",
   ```
5. Check that the subgraph compiles and builds correctly:
   ```bash
   pnpm run build:XXX:v2
   ```
6. Create the subgraph XXX on [The Graph Studio](https://thegraph.com/studio/)
7. Authenticate to The Graph Studio:
   ```bash
   graph auth <ACCESS_TOKEN>
   ```
8. Deploy the subgraph:
   ```bash
    pnpm run deploy:XXX:v2
   ```
